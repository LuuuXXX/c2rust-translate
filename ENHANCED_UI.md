# 增强的用户交互界面

本文档描述了在 c2rust-translate 工具中实现的增强用户交互功能。

## 概述

该工具现在提供了更直观和灵活的用户交互体验，包括：
- 并排代码比较显示
- 基于上下文的交互式提示
- 用于批处理的自动接受模式
- 在所有交互场景中保持一致的用户界面

## 新功能

### 1. 代码比较显示

该工具现在以格式化的比较视图并排显示 C 和 Rust 代码：

```
═══════════════════════════════════════════════════════════════════
                   C vs Rust 代码比较                        
═══════════════════════════════════════════════════════════════════
┌─────── C 源代码 ────────┬─────── Rust 代码 ────────────────┐
│ 1 int add(int a, int b) {    │ 1 pub fn add(a: i32, b: i32)    │
│ 2     return a + b;          │ 2     -> i32 {                  │
│ 3 }                          │ 3     a + b                      │
│                              │ 4 }                              │
└──────────────────────────────┴──────────────────────────────────┘

═══════════════════════════════════════════════════════════════════
                         测试结果                                
═══════════════════════════════════════════════════════════════════
✓ 所有测试通过
```

### 2. 基于上下文的交互式提示

#### 场景 1：编译成功且测试通过

当编译成功且所有测试通过时，您会看到 4 个选项：

```
✓ 编译和测试成功！

您想做什么？

可用选项：
  1. 接受此代码（将被提交）
  2. 自动接受所有后续翻译
  3. 手动修复（使用 VIM 编辑文件）
  4. 退出（中止翻译过程）

输入您的选择 (1/2/3/4):
```

**选项 1 - 接受**：接受当前翻译并提交。

**选项 2 - 自动接受**：为当前会话启用自动接受模式，自动接受所有未来的成功翻译而无需提示。对批处理很有用。

**选项 3 - 手动修复**：在 VIM 中打开 Rust 文件进行手动编辑，然后重新构建和测试。

**选项 4 - 退出**：中止翻译过程。

#### 场景 2：测试失败

当编译成功但测试失败时，您会看到 3 个选项：

```
⚠ 测试失败 - 您想做什么？

可用选项：
  1. 添加修复建议让 AI 修改
  2. 手动修复（使用 VIM 编辑文件）
  3. 退出（中止翻译过程）

输入您的选择 (1/2/3):
```

**选项 1 - 添加建议**：提示您输入修复建议，AI 将使用该建议修改代码。

**选项 2 - 手动修复**：在 VIM 中打开文件进行手动编辑。

**选项 3 - 退出**：中止翻译过程。

#### 场景 3：编译失败（达到最大重试次数）

当达到最大修复尝试次数后编译仍然失败时，您会看到 3 个选项：

```
⚠ 编译失败 - 您想做什么？

可用选项：
  1. 添加修复建议让 AI 修改
  2. 手动修复（使用 VIM 编辑文件）
  3. 退出（中止翻译过程）

输入您的选择 (1/2/3):
```

这些选项的工作方式与测试失败场景相同。

### 3. 自动接受模式

自动接受模式允许您在无需手动干预的情况下处理多个文件：

- 通过在测试通过时选择选项 2 启用
- 启用后，所有未来的成功翻译都会自动被接受
- 对批量处理大型代码库特别有用
- 模式基于会话（重启工具时会重置）

### 4. 改进的错误上下文

所有交互式提示现在都会显示：
- 文件位置（C 源文件和 Rust 目标文件）
- 并排代码比较
- 构建或测试错误消息
- 清晰的结果指示器（✓ 表示成功，✗ 表示失败）

## 实现细节

### 新模块

- **`src/diff_display.rs`**：处理并排代码比较显示
- 增强的 **`src/interaction.rs`**：为不同场景提供新的枚举和提示

### 新枚举

```rust
// 用于编译成功且测试通过的情况
pub enum CompileSuccessChoice {
    Accept,
    AutoAccept,
    ManualFix,
    Exit,
}

// 用于测试或编译失败的情况
pub enum FailureChoice {
    AddSuggestion,
    ManualFix,
    Exit,
}
```

### 关键函数

- `prompt_compile_success_choice()`：测试成功时的 4 选项提示
- `prompt_test_failure_choice()`：测试失败时的 3 选项提示
- `prompt_compile_failure_choice()`：编译失败时的 3 选项提示
- `display_code_comparison()`：并排代码显示
- `is_auto_accept_mode()`, `enable_auto_accept_mode()`：自动接受模式管理

## 向后兼容性

增强的用户界面保持向后兼容性：
- 保留现有的 `UserChoice` 枚举以实现兼容性
- 旧提示在需要时仍然有效
- 所有新功能都是附加的，而不是替换现有功能

## 测试

运行测试套件以验证实现：

```bash
cargo test
```

所有 60+ 个单元测试都通过，确保：
- 枚举变体正常工作
- 自动接受模式状态管理正常运作
- 代码比较显示处理边缘情况
- 文件路径显示正常工作

