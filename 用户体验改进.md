# c2rust-translate 用户体验改进说明

## 概述

本文档说明了为提升 c2rust-translate 工具的可见性、进度追踪和整体易用性而实现的用户体验改进。

## 已实现的改进

### 1. 翻译和修复内容输出增强

#### 改进前
- 无法预览正在翻译的 C 代码
- 无法预览正在修复的编译错误
- 翻译过程中反馈信息较少

#### 改进后
- **C 代码预览**：翻译前显示 C 源代码的前 15 行（默认），使用 `--show-full-output` 可显示完整内容
- **错误预览**：应用修复前显示构建错误的前 10 行（默认），使用 `--show-full-output` 可显示完整内容
- **文件信息**：显示文件类型、名称和源路径
- **结果反馈**：显示翻译后的文件大小和成功标识
- **灵活的输出控制**：通过 `--show-full-output` 标志可以选择查看完整的代码和错误信息，方便详细调试

#### 示例输出
```
│ ─ C Source Preview ─
│   1 int add(int a, int b) {
│   2     return a + b;
│   3 }
│ ... (showing 3 of 50 lines)
│
│ Executing translation command:
│ → python translate_and_fix.py --config config.toml --type fn --code add.c --output add.rs
│
│ ✓ Translation complete (234 bytes)
```

**使用 `--show-full-output` 时**：
```
│ ─ C Source Preview ─
│   1 int add(int a, int b) {
│   2     return a + b;
│   3 }
... (显示全部 50 行)
│  50 }
│
│ Executing translation command:
│ → python translate_and_fix.py --config config.toml --type fn --code add.c --output add.rs
│
│ ✓ Translation complete (234 bytes)
```

### 2. 进度跟踪

#### 改进前
- 每次运行时通过计数空文件来计算进度
- 不同执行之间无持久化
- 重新运行工具时进度会重置

#### 改进后
- **基于文件内容的进度跟踪**：通过检测 `.rs` 文件是否为空来判断处理状态
- **自动跳过已处理文件**：空文件表示未处理，非空文件表示已处理
- **无需额外文件**：进度状态与实际文件状态自动同步
- **连续进度编号**：进度显示基于所有文件的总数，已处理的文件会被计入进度

#### 工作原理
- 未处理的文件：空 `.rs` 文件
- 已处理的文件：包含 Rust 代码的非空 `.rs` 文件
- 中断后恢复：自动扫描并跳过非空文件，只处理空文件
- 进度计算：总文件数 - 空文件数 = 已处理数

#### 示例输出

**首次运行（10个文件，全部为空）：**
```
Found 10 empty .rs file(s) to process

[1/10] Processing var_counter.rs
[2/10] Processing fun_add.rs
[3/10] Processing var_example.rs
...
```

**中断后重新运行（10个文件，6个已处理，4个空文件）：**
```
Found 4 empty .rs file(s) to process

[7/10] Processing var_temp.rs
[8/10] Processing fun_multiply.rs
...
```

已翻译的文件不会再次出现在待处理列表中，进度序号会从已处理的文件数继续累计。

### 3. 命令执行彩色高亮

#### 配色方案

- **构建命令**：亮蓝色（`│ → Executing build command:`）
- **测试命令**：亮绿色（`│ → Executing test command:`）
- **清理命令**：亮红色（`│ → Executing clean command:`）
- **成功消息**：带 ✓ 的亮绿色（`✓ Build successful`）
- **错误消息**：带 ✗ 的亮红色（`✗ BUILD failed`）
- **警告消息**：带 ⚠ 的黄色（`⚠ Build failed, attempting to fix errors...`）
- **进度信息**：亮品红色（`═══ Progress: 1/5 ═══`）
- **常规信息**：亮青色（`Starting translation for feature: default`）

#### 执行时间显示

所有命令现在都会显示执行时间：
```
│ ✓ Build successful (took 2.35s)
│ ✓ Test successful (took 1.12s)
│ ✓ Clean successful (took 0.45s)
```

### 4. 增强的工作流程可视化

#### 文件处理流程
```
┌─ Processing file: var_example.rs
│ File type: var
│ Name: example
│ C source: /path/to/var_example.c
│
│ ─ C Source Preview ─
│   1 int example = 42;
│
│ Translating var to Rust...
│ → python translate_and_fix.py ...
│
│ ✓ Translation complete (156 bytes)
│
│ Building Rust project (attempt 1/3)
│ ✓ Build successful!
│
│ Committing changes...
│ ✓ Changes committed
│
│ Updating code analysis...
│ ✓ Code analysis updated
└─ File processing complete
```

## 技术实现细节

### 新增依赖

`Cargo.toml` 中添加：
```toml
colored = "2.1"
chrono = "0.4"
```

### 新增模块

- **`src/progress.rs`**：进度状态管理
  - 用于跟踪翻译进度的 `ProgressState` 结构体
  - 基于内存的会话进度跟踪
  - 配合空文件检测实现自动恢复

### 修改的模块

1. **`src/lib.rs`**
   - 集成进度追踪
   - 添加彩色输出
   - 增强用户反馈

2. **`src/translator.rs`**
   - 添加 C 代码预览
   - 添加错误预览
   - 彩色命令输出

3. **`src/builder.rs`**
   - 添加执行计时
   - 按命令类型彩色编码
   - 增强结果显示

4. **`src/analyzer.rs`**
   - 修复 clippy 警告

5. **`src/git.rs`**
   - 修复 clippy 警告

6. **`src/file_scanner.rs`**
   - 改进前缀移除逻辑
   - 修复 clippy 警告

### 配置

`.gitignore` 现在不需要排除进度文件了，因为进度跟踪基于文件内容，不使用额外文件：
```
/target
```

## 测试

所有现有测试继续通过：
- 47 个单元测试
- clippy 无警告
- 使用 `--release` 成功构建

## 改进效果

1. **更好的可见性**：用户可以看到正在处理的代码内容
2. **进度持久化**：中断后可以恢复工作
3. **清晰的反馈**：彩色编码的输出使不同操作易于识别
4. **性能洞察**：计时信息有助于识别性能瓶颈
5. **专业的用户体验**：一致的格式和清晰的视觉层次

## 5. 交互式错误处理（新增）

### 改进前
- 达到最大修复次数后只能选择重试或跳过
- 无法输入修复建议或提示
- 测试失败时直接退出
- 无法手工编辑文件
- 代码显示可能被截断

### 改进后
- **三选项交互菜单**：继续尝试、手工修复、退出
- **修复建议系统**：可以输入提示词，保存到 `c2rust.md` 文件
- **完整代码显示**：交互时自动显示完整的 C 和 Rust 代码（不截断）
- **vim 集成**：手工修复选项自动打开 vim 编辑器
- **智能处理**：测试失败时要求必须输入建议才能继续

### 适用场景

1. **编译失败处理** - `handle_max_fix_attempts_reached` in `src/lib.rs`
   - 达到最大修复尝试次数时触发
   - 提供三个选项：继续（可选建议）、手工修复、退出
   - 显示完整的 C 和 Rust 代码以及错误信息

2. **测试失败处理** - `handle_test_failure_interactive` in `src/builder.rs`
   - 混合构建测试失败时触发
   - **必须**输入修复建议才能选择"继续"
   - 同样显示完整代码和错误信息

3. **启动失败处理** - `translate_feature` in `src/lib.rs`
   - 初始构建失败时提供交互选项
   - 初始测试失败时提供交互选项
   - 允许用户决定是否继续工作流程

### 技术实现

#### 新增模块

1. **`src/interaction.rs`** - 用户交互工具
   - `UserChoice` 枚举：Continue, ManualFix, Exit
   - `prompt_user_choice()` - 显示选项菜单并获取用户选择
   - `prompt_suggestion()` - 提示用户输入修复建议
   - `open_in_vim()` - 在 vim 中打开文件
   - `display_file_paths()` - 显示文件位置

2. **`src/suggestion.rs`** - 建议文件管理
   - `get_suggestion_file_path()` - 获取 c2rust.md 路径
   - `read_suggestions()` - 读取现有建议
   - `append_suggestion()` - 追加新建议到文件
   - `get_suggestions_for_translation()` - 获取建议用于翻译

#### 修改的模块

1. **`src/lib.rs`**
   - 重写 `handle_max_fix_attempts_reached()` 实现三选项菜单
   - 更新 `translate_feature()` 添加启动失败处理
   - 更新 `complete_file_processing()` 传递文件上下文
   - 公开 `apply_error_fix()` 供其他模块调用

2. **`src/builder.rs`**
   - 新增 `run_hybrid_build_interactive()` 支持交互式错误处理
   - 新增 `handle_test_failure_interactive()` 处理测试失败
   - 原 `run_hybrid_build()` 现在调用交互式版本

3. **`src/translator.rs`**
   - 更新 `build_fix_args()` 支持可选的 suggestion 参数
   - 更新 `fix_translation_error()` 自动检测并使用 c2rust.md
   - 公开 `display_code()` 供其他模块调用
   - 显示是否使用建议文件的信息

### 建议文件格式

`c2rust.md` 文件示例：
```markdown
## Suggestion added at 2024-01-15 10:30:25
Please use std::ffi::CStr instead of raw pointer manipulation

## Suggestion added at 2024-01-15 10:45:12
Ensure proper lifetime annotations for borrowed references

## Suggestion added at 2024-01-15 11:00:00
Use Option<T> for nullable pointers instead of *const T
```

### 示例输出

**编译失败交互**：
```
⚠ Maximum fix attempts reached!
File example.rs still has build errors after 10 fix attempts.

File Locations:
  C file:    /path/to/example.c
  Rust file: /path/to/example.rs

═══ C Source Code (Full) ═══
[完整C代码，所有行]

═══ Rust Code (Full) ═══
[完整Rust代码，所有行]

═══ Build Error ═══
error[E0308]: mismatched types
 --> example.rs:10:5
  |
10|     ptr as i32
  |     ^^^^^^^^^^ expected `i32`, found `*const i8`

⚠ Build failure - What would you like to do?

Available options:
  1. Continue trying (optionally enter a fix suggestion)
  2. Manual fix (edit the file directly)  
  3. Exit (skip this file and continue with next, or exit completely)

Enter your choice (1/2/3): 1

Please enter your fix suggestion:
Suggestion: Use proper pointer casting with as syntax

✓ Suggestion recorded: Use proper pointer casting with as syntax
✓ Suggestion saved to /path/to/project/c2rust.md
Retrying translation from scratch... (2 retries remaining)
```

**测试失败交互**（要求输入建议）：
```
⚠ Hybrid build tests failed!
The test suite did not pass.

[显示完整代码和错误]

⚠ Test failure - What would you like to do?

Available options:
  1. Continue trying (requires entering a fix suggestion)
  2. Manual fix (edit the file directly)
  3. Exit (skip this file and continue with next, or exit completely)

Enter your choice (1/2/3): 1

Please enter your fix suggestion:
(The suggestion will be saved and used in the next fix attempt)

Suggestion: Ensure the function signature matches the C prototype

✓ Suggestion recorded: Ensure the function signature matches the C prototype
[应用修复并重新测试...]
```

### 用户体验优势

1. **不会意外退出**：工具不会在遇到问题时直接退出，始终给用户选择的机会
2. **充分的信息**：显示完整的源代码和错误信息，帮助用户做出明智的决定
3. **灵活的处理方式**：可以让 AI 继续尝试、手工修复或跳过
4. **知识积累**：建议保存到文件中，可以在后续翻译中复用
5. **测试失败保护**：测试失败时强制要求输入建议，避免盲目重试
