# 自动化翻译工作流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    开始 auto_translate.py                        │
│                    --feature <feature>                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
                ┌───────────────────────┐
                │  检查 rust 目录是否存在  │
                └───────────┬───────────┘
                            │
                ┌───────────▼───────────┐
                │  目录是否存在？        │
                └───────┬───────┬───────┘
                   是   │       │  否
                        │       │
                        │       ▼
                        │  ┌──────────────────────┐
                        │  │ code-analyse --init  │
                        │  └──────────┬───────────┘
                        │             │
                        │             ▼
                        │  ┌──────────────────────┐
                        │  │   git commit         │
                        │  └──────────┬───────────┘
                        │             │
                        └─────────────┘
                            │
                            ▼
            ┌───────────────────────────────┐
            │  扫描 rust 目录下的空 .rs 文件  │
            └───────────────┬───────────────┘
                            │
                ┌───────────▼───────────┐
                │  是否有空文件？        │
                └───────┬───────┬───────┘
                   否   │       │  是
                        │       │
                        │       ▼
                        │  ┌──────────────────────────────┐
                        │  │  执行初始 cargo build         │
                        │  └──────────────┬───────────────┘
                        │                 │
                        │                 ▼
                        │  ┌──────────────────────────────┐
                        │  │  对每个空文件执行：           │
                        │  │                               │
                        │  │  1. 提取类型 (var/fun)        │
                        │  │  2. 查找对应 .c 文件          │
                        │  │  3. 调用 translate_and_fix.py │
                        │  └──────────────┬───────────────┘
                        │                 │
                        │                 ▼
                        │  ┌──────────────────────────────┐
                        │  │  编译与修复循环 (最多5次)：    │
                        │  │                               │
                        │  │  a. cargo build               │
                        │  │  b. 如有错误，提取错误信息     │
                        │  │  c. 调用 translate_and_fix.py │
                        │  │     --type fix 修复错误        │
                        │  │  d. 重复直到成功              │
                        │  └──────────────┬───────────────┘
                        │                 │
                        │                 ▼
                        │  ┌──────────────────────────────┐
                        │  │  git commit 翻译的文件        │
                        │  └──────────────┬───────────────┘
                        │                 │
                        │                 ▼
                        │  ┌──────────────────────────────┐
                        │  │  code-analyse --update        │
                        │  └──────────────┬───────────────┘
                        │                 │
                        │                 ▼
                        │  ┌──────────────────────────────┐
                        │  │  git commit 更新的文件        │
                        │  └──────────────┬───────────────┘
                        │                 │
                        │                 ▼
                        │  ┌──────────────────────────────┐
                        │  │  执行混合构建：               │
                        │  │  - c2rust-clean               │
                        │  │  - c2rust-build               │
                        │  │  - c2rust-test                │
                        │  │                               │
                        │  │  环境变量：                   │
                        │  │  LD_PRELOAD=<混合构建库>      │
                        │  │  C2RUST_FEATURE_ROOT=<dir>    │
                        │  └──────────────┬───────────────┘
                        │                 │
                        └─────────────────┘
                            │
                            ▼
                ┌───────────────────────┐
                │    所有文件处理完成    │
                │         退出          │
                └───────────────────────┘

```

## 错误处理路径

```
┌──────────────────────┐
│   任何步骤出错        │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  记录错误信息         │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  退出并返回错误码     │
└──────────────────────┘
```

## 用户交互点

```
┌──────────────────────────────┐
│  找不到对应的 .c 文件          │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│  询问：是否执行                │
│  code-analyse --init?         │
└──────┬───────────┬────────────┘
      是│          │否
        │          │
        ▼          ▼
  ┌─────────┐  ┌─────────┐
  │ 执行init│  │  退出    │
  └─────────┘  └─────────┘
```

## 关键步骤详解

### 1. 类型提取

```python
var_xxx.rs  →  type = "var"
fun_xxx.rs  →  type = "fn"
```

### 2. 翻译调用

```bash
python3 translate_and_fix.py \
    --config config.toml \
    --type <var|fn> \
    --code <c_file> \
    --output <rs_file>
```

### 3. 错误修复调用

```bash
python3 translate_and_fix.py \
    --config config.toml \
    --type fix \
    --code <rs_file> \
    --output <rs_file> \
    --error /tmp/error_message.txt
```

### 4. Git提交时机

1. 初始化完成后
2. 每个文件翻译并编译成功后
3. 代码分析更新后

### 5. 环境变量设置

执行混合构建时：
- `LD_PRELOAD` = 混合构建库路径（如果提供）
- `C2RUST_FEATURE_ROOT` = feature目录的绝对路径
